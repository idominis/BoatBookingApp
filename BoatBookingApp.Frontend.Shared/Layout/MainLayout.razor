@inherits LayoutComponentBase
@using MudBlazor
@using BoatBookingApp.Frontend.Shared.Models
@using BoatBookingApp.Frontend.Shared.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BoatBookingContext> DbContextFactory

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3">Boat Booking App</MudText>
        <MudSpacer />
        <MudToolBarContent Class="d-flex justify-end">
            <MudSelect T="string" Label="Booker" Value="@BookerState.SelectedBookerShortName" ValueChanged="@((string shortName) => OnBookerChanged(shortName))"
                       Dense="true" Variant="Variant.Text" Class="compact-select">
                @foreach (var booker in bookers)
                {
                    <MudSelectItem Value="@booker.ShortName">@booker.ShortName</MudSelectItem>
                }
            </MudSelect>
        </MudToolBarContent>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    [Inject]
    public BookerStateService BookerState { get; set; }

    bool _drawerOpen = true;
    private List<Booker> bookers = new List<Booker>();

    protected override async Task OnInitializedAsync()
    {
        using var dbContext = DbContextFactory.CreateDbContext();
        bookers = await dbContext.Bookers.ToListAsync();

        var defaultBooker = bookers.FirstOrDefault(b => b.ShortName == "ID");
        if (defaultBooker != null)
        {
            BookerState.SetSelectedBookerShortName("ID");
        }
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    void OnBookerChanged(string shortName)
    {
        BookerState.SetSelectedBookerShortName(shortName);
        Console.WriteLine($"Odabrani buker: {shortName}");
    }
}

<style>
    .compact-select {
        width: 80px !important;
        max-width: 80px !important;
        min-width: 50px;
        margin-right: 8px;
    }

    .compact-select .mud-input-control {
        width: 80px !important;
        max-width: 80px !important;
    }

    .compact-select .mud-select-input {
        color: white !important;
        font-weight: bold !important;
        text-align: center !important;
    }

    .compact-select .mud-select-item {
        color: black !important;
        font-weight: bold !important;
    }
</style>